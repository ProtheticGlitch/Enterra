{% extends "base.html" %}
{% from "_macros.html" import render_field %}
{% block title %}Enterra ‚Äî {% if mode == "new" %}–ù–æ–≤—ã–π –ø–æ—Å—Ç{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% endif %}{% endblock %}

{% block content %}
  <div class="row justify-content-center mt-4">
    <div class="col-lg-8">
      <div class="portal-panel p-3 p-lg-4">
        <div class="d-flex justify-content-between align-items-center">
          <div class="h4 mb-0">{% if mode == "new" %}–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç{% else %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç{% endif %}</div>
          <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.index') }}">–í –ª–µ–Ω—Ç—É</a>
        </div>

        <form method="post" class="mt-3" enctype="multipart/form-data">
          {{ form.hidden_tag() }}
          {{ render_field(form.title, "–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ–¥–±–æ—Ä–∫–∞ –º–µ–º–æ–≤ –ø—Ä–æ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫") }}
          {{ render_field(form.summary, "–ö–æ—Ä–æ—Ç–∫–æ: –æ —á—ë–º –ø–æ—Å—Ç (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)") }}
          
          <div class="mb-3">
            <label class="form-label" for="{{ form.cover_emoji.id }}">{{ form.cover_emoji.label.text }}</label>
            <div class="emoji-picker-container">
              <input type="text" 
                     class="form-control emoji-input" 
                     id="{{ form.cover_emoji.id }}" 
                     name="{{ form.cover_emoji.name }}" 
                     value="{{ form.cover_emoji.data or '' }}"
                     placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —ç–º–æ–¥–∑–∏ –Ω–∏–∂–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π"
                     maxlength="8">
              <div class="emoji-preview mt-2 mb-2">
                <span class="emoji-display">{% if form.cover_emoji.data %}{{ form.cover_emoji.data }}{% else %}‚ú®{% endif %}</span>
              </div>
              <div class="emoji-grid">
                <button type="button" class="emoji-btn" data-emoji="üé¨" title="–ö–∏–Ω–æ">üé¨</button>
                <button type="button" class="emoji-btn" data-emoji="üéÆ" title="–ò–≥—Ä—ã">üéÆ</button>
                <button type="button" class="emoji-btn" data-emoji="üéß" title="–ú—É–∑—ã–∫–∞">üéß</button>
                <button type="button" class="emoji-btn" data-emoji="ü§£" title="–°–º–µ—à–Ω–æ">ü§£</button>
                <button type="button" class="emoji-btn" data-emoji="üî•" title="–ì–æ—Ä—è—á–µ–µ">üî•</button>
                <button type="button" class="emoji-btn" data-emoji="üí°" title="–ò–¥–µ—è">üí°</button>
                <button type="button" class="emoji-btn" data-emoji="üì±" title="–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏">üì±</button>
                <button type="button" class="emoji-btn" data-emoji="üé≠" title="–ò—Å–∫—É—Å—Å—Ç–≤–æ">üé≠</button>
                <button type="button" class="emoji-btn" data-emoji="‚ö°" title="–ë—ã—Å—Ç—Ä–æ">‚ö°</button>
                <button type="button" class="emoji-btn" data-emoji="üåü" title="–ó–≤–µ–∑–¥–∞">üåü</button>
                <button type="button" class="emoji-btn" data-emoji="üí¨" title="–û–±—Å—É–∂–¥–µ–Ω–∏–µ">üí¨</button>
                <button type="button" class="emoji-btn" data-emoji="üé®" title="–î–∏–∑–∞–π–Ω">üé®</button>
                <button type="button" class="emoji-btn" data-emoji="üçø" title="–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è">üçø</button>
                <button type="button" class="emoji-btn" data-emoji="üöÄ" title="–ù–æ–≤–æ–µ">üöÄ</button>
                <button type="button" class="emoji-btn" data-emoji="‚ù§Ô∏è" title="–°–µ—Ä–¥—Ü–µ">‚ù§Ô∏è</button>
                <button type="button" class="emoji-btn" data-emoji="üéØ" title="–¶–µ–ª—å">üéØ</button>
                <button type="button" class="emoji-btn" data-emoji="‚ú®" title="–í–æ–ª—à–µ–±—Å—Ç–≤–æ">‚ú®</button>
              </div>
            </div>
            {% if form.cover_emoji.errors %}
              <div class="form-text text-danger">{{ form.cover_emoji.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.tags.id }}">{{ form.tags.label.text }}</label>
            {{ form.tags(class_="form-control", placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: –º–µ–º—ã, –∫–∏–Ω–æ, –∏–≥—Ä—ã", id="tags-input") }}
            <div id="tag-status" class="mt-2"></div>
            <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–≥–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –û–Ω–∏ –ø–æ–º–æ–≥—É—Ç –¥—Ä—É–≥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –Ω–∞–π—Ç–∏ –≤–∞—à –ø–æ—Å—Ç.</div>
            <div id="tag-suggestions" class="mt-2"></div>
            {% if form.tags.errors %}
              <div class="form-text text-danger">{{ form.tags.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <div class="portal-panel p-3">
              <div id="tracks-container">
                {% if mode == "edit" and post.tracks %}
                  {% for track in post.tracks %}
                    <div class="track-item mb-3 p-3" style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); border-radius: 12px;">
                      <input type="hidden" name="track_ids" value="{{ track.id }}">
                      <div class="row g-2">
                        <div class="col-md-5">
                          <input type="text" name="track_titles" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞" value="{{ track.title }}" required>
                        </div>
                        <div class="col-md-4">
                          <input type="text" name="track_artists" class="form-control" placeholder="–ê—Ä—Ç–∏—Å—Ç" value="{{ track.artist }}" required>
                        </div>
                        <div class="col-md-3">
                          <div class="d-flex gap-1">
                            <input type="url" name="track_urls" class="form-control" placeholder="–°—Å—ã–ª–∫–∞" value="{{ track.url or '' }}">
                            <button type="button" class="btn btn-sm btn-outline-danger track-remove">√ó</button>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
              <button type="button" class="btn btn-sm btn-outline-light mt-2" id="add-track-btn">+ –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫</button>
              <div class="form-text mt-2">–î–æ–±–∞–≤—å—Ç–µ —Ç—Ä–µ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —É–ø–æ–º–∏–Ω–∞—é—Ç—Å—è –≤ –ø–æ—Å—Ç–µ. –ú–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –Ω–∞ Spotify, YouTube –∏ —Ç.–¥.</div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.body.id }}">{{ form.body.label.text }}</label>
            <textarea id="editor" name="{{ form.body.name }}" class="form-control" rows="10" placeholder="–ü–∏—à–∏ –∫–∞–∫ —Ö–æ—á–µ—à—å: —Å–ø–∏—Å–∫–æ–º, –∞–±–∑–∞—Ü–∞–º–∏, —Å –ø–µ—Ä–µ–Ω–æ—Å–∞–º–∏ —Å—Ç—Ä–æ–∫‚Ä¶">{{ form.body.data or '' }}</textarea>
            {% if form.body.errors %}
              <div class="form-text text-danger">{{ form.body.errors[0] }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label" for="{{ form.media.id }}">{{ form.media.label.text }}</label>
            {{ form.media(class_="form-control") }}
            <div class="form-text">
              –ú–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å –æ–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (jpg, png, webp, gif) –∏–ª–∏ –≤–∏–¥–µ–æ (mp4, webm, mov).
            </div>
          </div>

          <div class="form-check mb-3">
            {{ form.is_published(class_="form-check-input") }}
            <label class="form-check-label" for="{{ form.is_published.id }}">{{ form.is_published.label.text }}</label>
          </div>

          <button class="btn btn-primary">{% if mode == "new" %}–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å{% else %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å{% endif %}</button>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.ckeditor.com/ckeditor5/41.1.0/classic/ckeditor.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è CKEditor —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏
      ClassicEditor
        .create(document.querySelector('#editor'), {
          toolbar: {
            items: [
              'heading', '|',
              'bold', 'italic', 'underline', 'strikethrough', '|',
              'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
              'alignment', '|',
              'numberedList', 'bulletedList', '|',
              'outdent', 'indent', '|',
              'link', 'blockQuote', 'insertTable', 'imageUpload', 'mediaEmbed', '|',
              'code', 'codeBlock', '|',
              'undo', 'redo'
            ],
            shouldNotGroupWhenFull: true
          },
          heading: {
            options: [
              { model: 'paragraph', title: '–ü–∞—Ä–∞–≥—Ä–∞—Ñ', class: 'ck-heading_paragraph' },
              { model: 'heading1', view: 'h1', title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 1', class: 'ck-heading_heading1' },
              { model: 'heading2', view: 'h2', title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 2', class: 'ck-heading_heading2' },
              { model: 'heading3', view: 'h3', title: '–ó–∞–≥–æ–ª–æ–≤–æ–∫ 3', class: 'ck-heading_heading3' }
            ]
          },
          fontSize: {
            options: [9, 11, 13, 'default', 17, 19, 21, 27, 35]
          },
          fontFamily: {
            options: [
              'default',
              'Arial, Helvetica, sans-serif',
              'Courier New, Courier, monospace',
              'Georgia, serif',
              'Lucida Sans Unicode, Lucida Grande, sans-serif',
              'Tahoma, Geneva, sans-serif',
              'Times New Roman, Times, serif',
              'Trebuchet MS, Helvetica, sans-serif',
              'Verdana, Geneva, sans-serif'
            ]
          },
          link: {
            decorators: {
              openInNewTab: {
                mode: 'manual',
                label: '–û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ',
                attributes: {
                  target: '_blank',
                  rel: 'noopener noreferrer'
                }
              }
            }
          },
          table: {
            contentToolbar: ['tableColumn', 'tableRow', 'mergeTableCells']
          }
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ CKEditor:', error);
        });

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–µ–≥–æ–≤
      const tagsInput = document.getElementById('tags-input');
      const tagStatus = document.getElementById('tag-status');
      const tagSuggestions = document.getElementById('tag-suggestions');
      let checkTimeout;

      tagsInput.addEventListener('input', function() {
        clearTimeout(checkTimeout);
        const value = this.value.trim();
        if (!value) {
          tagStatus.innerHTML = '';
          tagSuggestions.innerHTML = '';
          return;
        }

        // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ (–ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∑–∞–ø—è—Ç–æ–π)
        const tags = value.split(',').map(t => t.trim()).filter(t => t);
        const lastTag = tags[tags.length - 1];

        if (lastTag && lastTag.length >= 2) {
          checkTimeout = setTimeout(() => {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ç–µ–≥–∞
            fetch(`{{ url_for('main.check_tag') }}?name=${encodeURIComponent(lastTag)}`)
              .then(response => response.json())
              .then(data => {
                if (data.exists) {
                  tagStatus.innerHTML = `<span class="badge text-bg-success">‚úì –¢–µ–≥ "${data.tag.name}" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç</span>`;
                } else {
                  tagStatus.innerHTML = `<span class="badge text-bg-info">+ –ù–æ–≤—ã–π —Ç–µ–≥ "${lastTag}"</span>`;
                }
              })
              .catch(error => console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–µ–≥–∞:', error));

            // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            fetch(`{{ url_for('main.tag_suggestions') }}?q=${encodeURIComponent(lastTag)}`)
              .then(response => response.json())
              .then(data => {
                let html = '';
                if (data.suggestions && data.suggestions.length > 0) {
                  const suggestionsHtml = data.suggestions.map(tag => 
                    `<span class="badge text-bg-light me-1 mb-1 tag-suggestion-badge" style="cursor: pointer; user-select: none;" data-tag-name="${tag.name}" title="–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å">#${tag.name}</span>`
                  ).join('');
                  html += `<div class="small text-secondary mb-1">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:</div><div class="d-flex flex-wrap gap-1">${suggestionsHtml}</div>`;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                {% if current_user.is_authenticated %}
                fetch(`{{ url_for('main.tag_recommendations') }}`)
                  .then(response => response.json())
                  .then(recData => {
                    if (recData.recommendations && recData.recommendations.length > 0 && lastTag.length < 2) {
                      const recHtml = recData.recommendations.map(tag => 
                        `<span class="badge text-bg-primary me-1 mb-1 tag-suggestion-badge" style="cursor: pointer; user-select: none;" data-tag-name="${tag.name}" title="–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π. –ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å">#${tag.name} ‚≠ê</span>`
                      ).join('');
                      if (html) html += '<div class="small text-secondary mb-1 mt-2">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å:</div>';
                      else html = '<div class="small text-secondary mb-1">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –≤–∞—Å:</div>';
                      html += `<div class="d-flex flex-wrap gap-1">${recHtml}</div>`;
                    }
                    tagSuggestions.innerHTML = html;
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –≤—Å–µ—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö —Ç–µ–≥–æ–≤
                    document.querySelectorAll('.tag-suggestion-badge').forEach(badge => {
                      badge.addEventListener('click', function() {
                        const tagName = this.getAttribute('data-tag-name');
                        addTag(tagName);
                      });
                      // –î–æ–±–∞–≤–ª—è–µ–º hover —ç—Ñ—Ñ–µ–∫—Ç
                      badge.addEventListener('mouseenter', function() {
                        this.style.opacity = '0.8';
                        this.style.transform = 'scale(1.05)';
                      });
                      badge.addEventListener('mouseleave', function() {
                        this.style.opacity = '1';
                        this.style.transform = 'scale(1)';
                      });
                    });
                  })
                  .catch(error => console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π:', error));
                {% else %}
                tagSuggestions.innerHTML = html;
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–∞ –¥–ª—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
                if (html) {
                  document.querySelectorAll('.tag-suggestion-badge').forEach(badge => {
                    badge.addEventListener('click', function() {
                      const tagName = this.getAttribute('data-tag-name');
                      addTag(tagName);
                    });
                    badge.addEventListener('mouseenter', function() {
                      this.style.opacity = '0.8';
                      this.style.transform = 'scale(1.05)';
                    });
                    badge.addEventListener('mouseleave', function() {
                      this.style.opacity = '1';
                      this.style.transform = 'scale(1)';
                    });
                  });
                }
                {% endif %}
              })
              .catch(error => console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π:', error));
          }, 500);
        }
      });

      function addTag(tagName) {
        const currentValue = tagsInput.value.trim();
        const tags = currentValue.split(',').map(t => t.trim()).filter(t => t);
        
        // –£–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –Ω–µ–ø–æ–ª–Ω—ã–π —Ç–µ–≥, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å (–º–µ–Ω–µ–µ 2 —Å–∏–º–≤–æ–ª–æ–≤)
        if (tags.length > 0 && tags[tags.length - 1].length < 2) {
          tags.pop();
        }
        
        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π —Ç–µ–≥, –µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç
        if (!tags.includes(tagName)) {
          tags.push(tagName);
          tagsInput.value = tags.join(', ') + ', ';
          tagStatus.innerHTML = `<span class="badge text-bg-success">‚úì –¢–µ–≥ "${tagName}" –¥–æ–±–∞–≤–ª–µ–Ω</span>`;
        } else {
          tagStatus.innerHTML = `<span class="badge text-bg-warning">–¢–µ–≥ "${tagName}" —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω</span>`;
        }
        
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫—É—Ä—Å–æ—Ä–∞ –≤ –∫–æ–Ω–µ—Ü
        tagsInput.focus();
        const len = tagsInput.value.length;
        tagsInput.setSelectionRange(len, len);
        
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
        tagSuggestions.innerHTML = '';
        
        // –¢—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ input –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        tagsInput.dispatchEvent(new Event('input'));
      }

      const emojiInput = document.getElementById('{{ form.cover_emoji.id }}');
      const emojiDisplay = document.querySelector('.emoji-display');
      const emojiButtons = document.querySelectorAll('.emoji-btn');
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —ç–º–æ–¥–∑–∏
      emojiButtons.forEach(btn => {
        btn.addEventListener('click', function() {
          const emoji = this.getAttribute('data-emoji');
          emojiInput.value = emoji;
          emojiDisplay.textContent = emoji;
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
          emojiButtons.forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
        });
      });
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ –ø–æ–ª–µ
      emojiInput.addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
          emojiDisplay.textContent = value;
          // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–æ–∫ –µ—Å–ª–∏ –≤–≤–æ–¥–∏–º —Å–≤–æ–π —ç–º–æ–¥–∑–∏
          emojiButtons.forEach(b => {
            if (b.getAttribute('data-emoji') === value) {
              emojiButtons.forEach(btn => btn.classList.remove('selected'));
              b.classList.add('selected');
            } else if (!value.match(/^[\p{Emoji}]+$/u)) {
              // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ —á—Ç–æ-—Ç–æ –Ω–µ-—ç–º–æ–¥–∑–∏, —Å–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ
              emojiButtons.forEach(btn => btn.classList.remove('selected'));
            }
          });
        } else {
          emojiDisplay.textContent = '‚ú®';
        }
      });
      
      // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —ç–º–æ–¥–∑–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const currentValue = emojiInput.value.trim();
      if (currentValue) {
        emojiButtons.forEach(btn => {
          if (btn.getAttribute('data-emoji') === currentValue) {
            btn.classList.add('selected');
          }
        });
      }

      // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–µ–∫–∞–º–∏
      const tracksContainer = document.getElementById('tracks-container');
      const addTrackBtn = document.getElementById('add-track-btn');
      let trackIndex = tracksContainer.children.length;

      addTrackBtn.addEventListener('click', function() {
        const trackItem = document.createElement('div');
        trackItem.className = 'track-item mb-3 p-3';
        trackItem.style.cssText = 'background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); border-radius: 12px;';
        trackItem.innerHTML = `
          <div class="row g-2">
            <div class="col-md-5">
              <input type="text" name="track_titles" class="form-control" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞" required>
            </div>
            <div class="col-md-4">
              <input type="text" name="track_artists" class="form-control" placeholder="–ê—Ä—Ç–∏—Å—Ç" required>
            </div>
            <div class="col-md-3">
              <div class="d-flex gap-1">
                <input type="url" name="track_urls" class="form-control" placeholder="–°—Å—ã–ª–∫–∞">
                <button type="button" class="btn btn-sm btn-outline-danger track-remove">√ó</button>
              </div>
            </div>
          </div>
        `;
        tracksContainer.appendChild(trackItem);
        trackIndex++;
      });

      tracksContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('track-remove')) {
          e.target.closest('.track-item').remove();
        }
      });
    });
  </script>
{% endblock %}


