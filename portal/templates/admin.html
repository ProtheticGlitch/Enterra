{% extends "base.html" %}
{% block title %}Enterra ‚Äî –ê–¥–º–∏–Ω{% endblock %}

{% block content %}
  <div class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="h4 mb-0">–ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å</div>
      <div class="text-secondary small">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è</div>
    </div>

    <div class="row g-3">
      <div class="col-lg-7">
        <div class="portal-panel p-3 p-lg-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ü–æ—Å—Ç—ã</div>
            <div class="text-secondary small">{% if post_search %}–ù–∞–π–¥–µ–Ω–æ: {{ posts|length }}{% else %}–ü–æ—Å–ª–µ–¥–Ω–∏–µ 100{% endif %}</div>
          </div>
          
          <!-- –ü–æ–∏—Å–∫ –ø–æ –ø–æ—Å—Ç–∞–º -->
          <form method="get" action="{{ url_for('main.admin') }}" class="mb-3">
            <div class="input-group">
              <input type="text" 
                     class="form-control portal-search" 
                     name="post_search" 
                     placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–≥–æ–ª–æ–≤–∫—É, —Ç–µ–∫—Å—Ç—É –∏–ª–∏ –∞–Ω–æ–Ω—Å—É..." 
                     value="{{ post_search or '' }}">
              <button class="btn btn-outline-light" type="submit">üîç –ù–∞–π—Ç–∏</button>
              {% if post_search %}
                <a href="{{ url_for('main.admin') }}" class="btn btn-outline-secondary">‚úï –°–±—Ä–æ—Å–∏—Ç—å</a>
              {% endif %}
            </div>
          </form>
          
          <div class="d-flex flex-column gap-2" style="max-height: 600px; overflow-y: auto; padding-right: 0.5rem;">
            {% for p in posts %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between gap-2">
                  <div class="me-2 flex-grow-1 min-w-0">
                    <div class="fw-semibold">
                      <a href="{{ url_for('main.post_detail', post_id=p.id) }}" class="text-decoration-none">{{ p.cover_emoji or "‚ú®" }} {{ p.title }}</a>
                      {% if not p.is_published %}<span class="badge text-bg-warning ms-2">–°–∫—Ä—ã—Ç</span>{% endif %}
                    </div>
                    <div class="text-secondary small">
                      –ê–≤—Ç–æ—Ä: <a href="{{ url_for('main.profile', username=p.author.username) }}">{{ p.author.username }}</a>
                      ¬∑ {{ p.created_at.strftime("%d.%m.%Y") }}
                    </div>
                  </div>
                  <div class="d-flex gap-2 flex-shrink-0">
                    <form method="post" action="{{ url_for('main.admin_toggle_post', post_id=p.id) }}">
                      <button class="btn btn-sm btn-outline-primary" type="submit">
                        {% if p.is_published %}–°–∫—Ä—ã—Ç—å{% else %}–ü–æ–∫–∞–∑–∞—Ç—å{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('main.admin_delete_post', post_id=p.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
            {% if not posts %}
              <div class="text-secondary text-center py-3">–ü–æ—Å—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
            {% endif %}
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</div>
            <div class="text-secondary small">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 50</div>
          </div>
          <div class="d-flex flex-column gap-2">
            {% for c in comments %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between gap-2">
                  <div class="me-2">
                    <div class="text-secondary small">
                      <a href="{{ url_for('main.profile', username=c.author.username) }}">{{ c.author.username }}</a>
                      ‚Üí <a href="{{ url_for('main.post_detail', post_id=c.post.id) }}">{{ c.post.title[:48] }}{% if c.post.title|length > 48 %}‚Ä¶{% endif %}</a>
                      ¬∑ {{ c.created_at.strftime("%d.%m.%Y %H:%M") }}
                    </div>
                    <div class="mt-1">{{ c.body | replace("\n", "<br>") | safe }}</div>
                  </div>
                  <form method="post" action="{{ url_for('main.admin_delete_comment', comment_id=c.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                </div>
              </div>
            {% endfor %}
            {% if not comments %}
              <div class="text-secondary">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="portal-panel p-3 p-lg-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
            <div class="text-secondary small">–í—Å–µ–≥–æ: {{ users|length }}</div>
          </div>
          <div class="d-flex flex-column gap-2">
            {% for u in users %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-semibold">
                      <a href="{{ url_for('main.profile', username=u.username) }}" class="text-decoration-none">{{ u.username }}</a>
                      {% if u.is_admin %}<span class="badge text-bg-warning ms-2">–ê–¥–º–∏–Ω</span>{% endif %}
                    </div>
                    <div class="text-secondary small">{{ u.email }}</div>
                  </div>
                  <div class="d-flex gap-2">
                    <form method="post" action="{{ url_for('main.admin_toggle_user', user_id=u.id) }}">
                      <button class="btn btn-sm btn-outline-warning" type="submit">
                        {% if u.is_admin %}–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞{% else %}–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('main.admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–µ—Å—å –µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
            <div class="text-secondary small">{{ categories|length }}</div>
          </div>

          <form method="post" action="{{ url_for('main.admin_create_category') }}" class="portal-admin-row p-3 mb-3">
            {{ category_form.hidden_tag() }}
            <div class="row g-2">
              <div class="col-md-6">
                {{ category_form.title(class_="form-control", placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω–∏–º–µ)") }}
              </div>
              <div class="col-md-6">
                {{ category_form.slug(class_="form-control", placeholder="slug (–Ω–∞–ø—Ä–∏–º–µ—Ä: anime)") }}
              </div>
            </div>
            <button class="btn btn-sm btn-primary mt-2" type="submit">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
          </form>

          <div class="d-flex flex-column gap-2">
            {% for cat in categories %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-semibold">{{ cat.title }}</div>
                    <div class="text-secondary small">{{ cat.slug }}</div>
                  </div>
                  <form method="post" action="{{ url_for('main.admin_delete_category', category_id=cat.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é? –û–Ω–∞ –±—É–¥–µ—Ç –æ—Ç–≤—è–∑–∞–Ω–∞ –æ—Ç –ø–æ—Å—Ç–æ–≤.');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
                  </form>
                </div>
              </div>
            {% endfor %}
            {% if not categories %}
              <div class="text-secondary">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</div>
            {% endif %}
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ç–µ–≥–æ–≤</div>
            <div class="text-secondary small" id="tags-count">{{ moderated_tag_ids|length }} –º–æ–¥–µ—Ä–∏—Ä—É–µ–º—ã—Ö / {{ all_tags|length }} –≤—Å–µ–≥–æ</div>
          </div>
          <div class="text-secondary small mb-3">
            –ü–æ—Å—Ç—ã —Å –æ—Ç–º–µ—á–µ–Ω–Ω—ã–º–∏ —Ç–µ–≥–∞–º–∏ –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã—Ç—ã –∏ –ø–æ—Ç—Ä–µ–±—É—é—Ç –º–æ–¥–µ—Ä–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–µ–π.
            <div class="mt-2">
              <strong>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</strong> –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ—Å—Ç–∞ —Å –º–æ–¥–µ—Ä–∏—Ä—É–µ–º—ã–º —Ç–µ–≥–æ–º, –ø–æ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫ –∏ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
            </div>
          </div>
          
          <!-- –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º -->
          <div class="mb-3">
            <input type="text" 
                   class="form-control portal-search" 
                   id="tag-search-input" 
                   placeholder="–ü–æ–∏—Å–∫ —Ç–µ–≥–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ slug..." 
                   autocomplete="off">
          </div>
          
          <div class="d-flex flex-column gap-2" id="tags-list" style="max-height: 400px; overflow-y: auto;">
            {% for tag in all_tags %}
              <div class="portal-admin-row p-2 tag-item" data-tag-name="{{ tag.name|lower }}" data-tag-slug="{{ tag.slug|lower }}">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-semibold">#{{ tag.name }}</div>
                    <div class="text-secondary small">{{ tag.slug }}</div>
                  </div>
                  <form method="post" action="{{ url_for('main.admin_toggle_tag_moderation', tag_id=tag.id) }}">
                    <button class="btn btn-sm {% if tag.id in moderated_tag_ids %}btn-warning{% else %}btn-outline-warning{% endif %}" type="submit">
                      {% if tag.id in moderated_tag_ids %}üîí –ú–æ–¥–µ—Ä–∏—Ä—É–µ—Ç—Å—è{% else %}üîì –û–±—ã—á–Ω—ã–π{% endif %}
                    </button>
                  </form>
                </div>
              </div>
            {% endfor %}
            {% if not all_tags %}
              <div class="text-secondary">–¢–µ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.</div>
            {% endif %}
            <div id="no-tags-found" class="text-secondary text-center py-3" style="display: none;">–¢–µ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞</div>
            <div class="text-secondary small">{{ bad_words_sorted|length }} —à—Ç.</div>
          </div>

          <form method="post" action="{{ url_for('main.admin_update_bad_words') }}">
            <div class="mb-2">
              <textarea
                name="bad_words"
                rows="8"
                class="form-control"
                spellcheck="false"
              >{% for w in bad_words_sorted %}{{ w }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
              <div class="form-text">
                –ü–æ –æ–¥–Ω–æ–º—É —Å–ª–æ–≤—É –≤ —Å—Ç—Ä–æ–∫–µ, –≤ –Ω–∏–∂–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ. –†–∞–±–æ—Ç–∞–µ—Ç –¥–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
              </div>
            </div>
            <button class="btn btn-sm btn-primary" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
          </form>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">–ê–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏—è</div>
            <form method="post" action="{{ url_for('main.admin_toggle_moderation') }}">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoModSwitch" name="auto_enabled" {% if auto_enabled %}checked{% endif %}>
                <label class="form-check-label" for="autoModSwitch">
                  {% if auto_enabled %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–í—ã–∫–ª—é—á–µ–Ω–∞{% endif %}
                </label>
              </div>
              <button class="btn btn-sm btn-outline-light mt-2" type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </form>
          </div>

          <div class="text-secondary small mb-2">
            –ù–∏–∂–µ ‚Äî –ø–æ—Å–ª–µ–¥–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è (–ø–æ—Å—Ç—ã/–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏/—Ñ–∞–π–ª—ã, –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é –∞–≤—Ç–æ–º–æ–¥–µ—Ä–∞—Ü–∏–µ–π).
            <div class="mt-2">
              <strong>–í–∞–∂–Ω–æ:</strong> –ü–æ—Å—Ç—ã –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è, –∞ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
            </div>
          </div>
          <div class="d-flex flex-column gap-2" style="max-height: 500px; overflow-y: auto;">
            {% for log in moderation_logs %}
              <div class="portal-admin-row p-3 small">
                <div class="d-flex justify-content-between gap-3">
                  <div class="flex-grow-1">
                    <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
                      <span class="badge {% if log.kind == 'post_deleted' %}text-bg-danger{% elif log.kind == 'post_autohide' %}text-bg-warning{% elif log.kind == 'comment_blocked' %}text-bg-danger{% elif log.kind == 'file_blocked' %}text-bg-info{% else %}text-bg-secondary{% endif %}">
                        {% if log.kind == 'post_deleted' %}üóëÔ∏è –ü–æ—Å—Ç —É–¥–∞–ª—ë–Ω
                        {% elif log.kind == 'post_autohide' %}üìù –ü–æ—Å—Ç –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                        {% elif log.kind == 'comment_blocked' %}üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                        {% elif log.kind == 'file_blocked' %}üìé –§–∞–π–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                        {% else %}{{ log.kind }}{% endif %}
                      </span>
                      {% if log.user_id %}
                        {% set user = users_dict.get(log.user_id) %}
                        {% if user %}
                          <a href="{{ url_for('main.profile', username=user.username) }}" class="text-decoration-none text-light">
                            üë§ {{ user.username }}
                          </a>
                        {% else %}
                          <span class="text-secondary">üë§ ID {{ log.user_id }}</span>
                        {% endif %}
                      {% endif %}
                      {% if log.post_id %}
                        <a href="{{ url_for('main.post_detail', post_id=log.post_id) }}" class="text-decoration-none">
                          üìÑ –ü–æ—Å—Ç #{{ log.post_id }}
                        </a>
                      {% endif %}
                    </div>
                    {% if log.snippet %}
                      <div class="text-secondary mt-2 p-2" style="background: rgba(255,255,255,.03); border-radius: 8px; font-family: monospace; font-size: 0.85rem; line-height: 1.5; word-break: break-word;">
                        {{ log.snippet }}
                      </div>
                    {% endif %}
                    {% if log.reason %}
                      <div class="text-secondary mt-2">
                        <strong>–ü—Ä–∏—á–∏–Ω–∞:</strong> 
                        {% if log.reason == 'bad_words' %}–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
                        {% elif log.reason == 'bad_words_edit' %}–ó–∞–ø—Ä–µ—â—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞ (–ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
                        {% elif log.reason == 'moderated_tags' %}–ú–æ–¥–µ—Ä–∏—Ä—É–µ–º—ã–µ —Ç–µ–≥–∏
                        {% elif log.reason == 'moderated_tags_edit' %}–ú–æ–¥–µ—Ä–∏—Ä—É–µ–º—ã–µ —Ç–µ–≥–∏ (–ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏)
                        {% elif log.reason == 'bad_extension_or_name' %}–ù–µ–¥–æ–ø—É—Å—Ç–∏–º–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
                        {% else %}{{ log.reason }}{% endif %}
                      </div>
                    {% endif %}
                  </div>
                  <div class="text-secondary text-end flex-shrink-0">
                    <div class="small">{{ log.created_at.strftime("%d.%m.%Y") }}</div>
                    <div class="small">{{ log.created_at.strftime("%H:%M") }}</div>
                  </div>
                </div>
              </div>
            {% endfor %}
            {% if not moderation_logs %}
              <div class="text-secondary small">–ù–∞—Ä—É—à–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–≥–∞–º
    document.addEventListener('DOMContentLoaded', function() {
      const searchInput = document.getElementById('tag-search-input');
      const tagsList = document.getElementById('tags-list');
      const tagItems = document.querySelectorAll('.tag-item');
      const tagsCount = document.getElementById('tags-count');
      const noTagsFound = document.getElementById('no-tags-found');
      
      if (searchInput) {
        searchInput.addEventListener('input', function() {
          const query = this.value.toLowerCase().trim();
          let visibleCount = 0;
          
          tagItems.forEach(item => {
            const tagName = item.getAttribute('data-tag-name') || '';
            const tagSlug = item.getAttribute('data-tag-slug') || '';
            
            if (!query || tagName.includes(query) || tagSlug.includes(query)) {
              item.style.display = '';
              visibleCount++;
            } else {
              item.style.display = 'none';
            }
          });
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
          if (visibleCount === 0 && query) {
            noTagsFound.style.display = 'block';
          } else {
            noTagsFound.style.display = 'none';
          }
        });
      }
    });
  </script>
{% endblock %}


