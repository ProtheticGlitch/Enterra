{% extends "base.html" %}
{% block title %}Enterra — Админ{% endblock %}

{% block content %}
  <div class="mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="h4 mb-0">Админ‑панель</div>
      <div class="text-secondary small">Управление контентом и модерация</div>
    </div>

    <div class="row g-3">
      <div class="col-lg-7">
        <div class="portal-panel p-3 p-lg-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">Посты</div>
            <div class="text-secondary small">Последние 100</div>
          </div>
          <div class="d-flex flex-column gap-2">
            {% for p in posts %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between gap-2">
                  <div class="me-2">
                    <div class="fw-semibold">
                      <a href="{{ url_for('main.post_detail', post_id=p.id) }}" class="text-decoration-none">{{ p.cover_emoji or "✨" }} {{ p.title }}</a>
                      {% if not p.is_published %}<span class="badge text-bg-warning ms-2">Скрыт</span>{% endif %}
                    </div>
                    <div class="text-secondary small">
                      Автор: <a href="{{ url_for('main.profile', username=p.author.username) }}">{{ p.author.username }}</a>
                      · {{ p.created_at.strftime("%d.%m.%Y") }}
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <form method="post" action="{{ url_for('main.admin_toggle_post', post_id=p.id) }}">
                      <button class="btn btn-sm btn-outline-primary" type="submit">
                        {% if p.is_published %}Скрыть{% else %}Показать{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('main.admin_delete_post', post_id=p.id) }}" onsubmit="return confirm('Удалить пост?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">Комментарии</div>
            <div class="text-secondary small">Последние 50</div>
          </div>
          <div class="d-flex flex-column gap-2">
            {% for c in comments %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between gap-2">
                  <div class="me-2">
                    <div class="text-secondary small">
                      <a href="{{ url_for('main.profile', username=c.author.username) }}">{{ c.author.username }}</a>
                      → <a href="{{ url_for('main.post_detail', post_id=c.post.id) }}">{{ c.post.title[:48] }}{% if c.post.title|length > 48 %}…{% endif %}</a>
                      · {{ c.created_at.strftime("%d.%m.%Y %H:%M") }}
                    </div>
                    <div class="mt-1">{{ c.body | replace("\n", "<br>") | safe }}</div>
                  </div>
                  <form method="post" action="{{ url_for('main.admin_delete_comment', comment_id=c.id) }}" onsubmit="return confirm('Удалить комментарий?');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                  </form>
                </div>
              </div>
            {% endfor %}
            {% if not comments %}
              <div class="text-secondary">Комментариев пока нет.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="portal-panel p-3 p-lg-4">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">Пользователи</div>
            <div class="text-secondary small">Всего: {{ users|length }}</div>
          </div>
          <div class="d-flex flex-column gap-2">
            {% for u in users %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-semibold">
                      <a href="{{ url_for('main.profile', username=u.username) }}" class="text-decoration-none">{{ u.username }}</a>
                      {% if u.is_admin %}<span class="badge text-bg-warning ms-2">Админ</span>{% endif %}
                    </div>
                    <div class="text-secondary small">{{ u.email }}</div>
                  </div>
                  <div class="d-flex gap-2">
                    <form method="post" action="{{ url_for('main.admin_toggle_user', user_id=u.id) }}">
                      <button class="btn btn-sm btn-outline-warning" type="submit">
                        {% if u.is_admin %}Снять админа{% else %}Сделать админом{% endif %}
                      </button>
                    </form>
                    <form method="post" action="{{ url_for('main.admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('Удалить пользователя и весь его контент?');">
                      <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">Категории</div>
            <div class="text-secondary small">{{ categories|length }}</div>
          </div>

          <form method="post" action="{{ url_for('main.admin_create_category') }}" class="portal-admin-row p-3 mb-3">
            {{ category_form.hidden_tag() }}
            <div class="row g-2">
              <div class="col-md-6">
                {{ category_form.title(class_="form-control", placeholder="Название (например: Аниме)") }}
              </div>
              <div class="col-md-6">
                {{ category_form.slug(class_="form-control", placeholder="slug (например: anime)") }}
              </div>
            </div>
            <button class="btn btn-sm btn-primary mt-2" type="submit">Добавить категорию</button>
          </form>

          <div class="d-flex flex-column gap-2">
            {% for cat in categories %}
              <div class="portal-admin-row p-2">
                <div class="d-flex justify-content-between align-items-center gap-2">
                  <div>
                    <div class="fw-semibold">{{ cat.title }}</div>
                    <div class="text-secondary small">{{ cat.slug }}</div>
                  </div>
                  <form method="post" action="{{ url_for('main.admin_delete_category', category_id=cat.id) }}" onsubmit="return confirm('Удалить категорию? Она будет отвязана от постов.');">
                    <button class="btn btn-sm btn-outline-danger" type="submit">Удалить</button>
                  </form>
                </div>
              </div>
            {% endfor %}
            {% if not categories %}
              <div class="text-secondary">Категорий пока нет.</div>
            {% endif %}
          </div>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">Запрещённые слова</div>
            <div class="text-secondary small">{{ bad_words_sorted|length }} шт.</div>
          </div>

          <form method="post" action="{{ url_for('main.admin_update_bad_words') }}">
            <div class="mb-2">
              <textarea
                name="bad_words"
                rows="8"
                class="form-control"
                spellcheck="false"
              >{% for w in bad_words_sorted %}{{ w }}{% if not loop.last %}
{% endif %}{% endfor %}</textarea>
              <div class="form-text">
                По одному слову в строке, в нижнем регистре. Работает до перезапуска приложения.
              </div>
            </div>
            <button class="btn btn-sm btn-primary" type="submit">Сохранить список</button>
          </form>
        </div>

        <div class="portal-panel p-3 p-lg-4 mt-3">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="h5 mb-0">Автомодерация</div>
            <form method="post" action="{{ url_for('main.admin_toggle_moderation') }}">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="autoModSwitch" name="auto_enabled" {% if auto_enabled %}checked{% endif %}>
                <label class="form-check-label" for="autoModSwitch">
                  {% if auto_enabled %}Включена{% else %}Выключена{% endif %}
                </label>
              </div>
              <button class="btn btn-sm btn-outline-light mt-2" type="submit">Применить</button>
            </form>
          </div>

          <div class="text-secondary small mb-2">
            Ниже — последние нарушения (посты/комментарии/файлы, отклонённые автомодерацией).
          </div>
          <div class="d-flex flex-column gap-2">
            {% for log in moderation_logs %}
              <div class="portal-admin-row p-2 small">
                <div class="d-flex justify-content-between">
                  <div>
                    <div class="fw-semibold">
                      {{ log.kind }}
                      {% if log.user_id %}
                        — пользователь ID {{ log.user_id }}
                      {% endif %}
                      {% if log.post_id %}
                        — пост ID {{ log.post_id }}
                      {% endif %}
                    </div>
                    {% if log.snippet %}
                      <div class="text-secondary mt-1">{{ log.snippet }}</div>
                    {% endif %}
                  </div>
                  <div class="text-secondary text-end">
                    {{ log.created_at.strftime("%d.%m %H:%M") }}
                    {% if log.reason %}<div>{{ log.reason }}</div>{% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
            {% if not moderation_logs %}
              <div class="text-secondary small">Нарушений пока не зафиксировано.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}


