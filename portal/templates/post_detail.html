{% extends "base.html" %}
{% from "_macros.html" import render_field %}
{% block title %}Enterra ‚Äî {{ post.title }}{% endblock %}

{% block content %}
  <div class="mt-4">
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-2">
      <div>
        <div class="d-flex gap-2 align-items-center">
          <div class="portal-emoji-lg">{{ post.cover_emoji or "‚ú®" }}</div>
          <h2 class="h3 mb-0">{{ post.title }}</h2>
        </div>
        <div class="text-secondary mt-1">
          –ê–≤—Ç–æ—Ä: <a href="{{ url_for('main.profile', username=post.author.username) }}">{{ post.author.username }}</a>
          ¬∑ {{ post.created_at.strftime("%d.%m.%Y %H:%M") }}
          ¬∑ üëÅÔ∏è {{ post.views }} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
          {% if not post.is_published %} ¬∑ <span class="badge text-bg-warning">–°–∫—Ä—ã—Ç</span>{% endif %}
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          {% for c in post.categories %}
            <a class="badge text-bg-light border text-decoration-none" href="{{ url_for('main.index', category=c.slug) }}">{{ c.title }}</a>
          {% endfor %}
          {% for tag in post.tags %}
            <a class="badge text-bg-light border text-decoration-none" href="{{ url_for('main.index', tag=tag.slug) }}">#{{ tag.name }}</a>
          {% endfor %}
        </div>
      </div>

      <div class="d-flex gap-2">
        {% if current_user.is_authenticated and (current_user.is_admin or current_user.id == post.author_id) %}
          <a class="btn btn-outline-primary" href="{{ url_for('main.post_edit', post_id=post.id) }}">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
          <form method="post" action="{{ url_for('main.post_delete', post_id=post.id) }}" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç?');">
            <button class="btn btn-outline-danger" type="submit">–£–¥–∞–ª–∏—Ç—å</button>
          </form>
        {% endif %}
      </div>
    </div>

    {% if post.summary %}
      <div class="portal-lead mt-3">{{ post.summary }}</div>
    {% endif %}

    {% if post.media_path %}
      <div class="mt-3">
        {% if post.media_type == "video" %}
          <video class="w-100 rounded-4" controls>
            <source src="{{ url_for('static', filename=post.media_path) }}">
          </video>
        {% else %}
          <img class="img-fluid rounded-4" src="{{ url_for('static', filename=post.media_path) }}" alt="–ú–µ–¥–∏–∞ –ø–æ—Å—Ç–∞">
        {% endif %}
      </div>
    {% endif %}

    <div class="d-flex align-items-center gap-3 mt-3">
      {% if current_user.is_authenticated %}
        <form method="post" action="{{ url_for('main.post_react', post_id=post.id, reaction_code='like') }}" class="d-inline">
          <button class="btn {% if user_reaction == 'like' %}btn-primary{% else %}btn-outline-light{% endif %}" type="submit">
            ‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è
            {% set like_count = reactions_counts.get('like', 0) %}
            {% if like_count %}<span class="badge bg-light text-dark ms-2">{{ like_count }}</span>{% endif %}
          </button>
        </form>
        <form method="post" action="{{ url_for('main.post_react', post_id=post.id, reaction_code='dislike') }}" class="d-inline">
          <button class="btn {% if user_reaction == 'dislike' %}btn-danger{% else %}btn-outline-light{% endif %}" type="submit">
            üëé –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è
            {% set dislike_count = reactions_counts.get('dislike', 0) %}
            {% if dislike_count %}<span class="badge bg-light text-dark ms-2">{{ dislike_count }}</span>{% endif %}
          </button>
        </form>
      {% else %}
        <span class="badge text-bg-light border">
          ‚ù§Ô∏è –ù—Ä–∞–≤–∏—Ç—Å—è {% set like_count = reactions_counts.get('like', 0) %}{% if like_count %}{{ like_count }}{% endif %}
        </span>
        <span class="badge text-bg-light border">
          üëé –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è {% set dislike_count = reactions_counts.get('dislike', 0) %}{% if dislike_count %}{{ dislike_count }}{% endif %}
        </span>
      {% endif %}
    </div>

    {% if current_user.is_authenticated and user_reaction == 'like' and similar_tags %}
      <div class="portal-panel p-3 p-lg-4 mt-4">
        <div class="fw-bold mb-2">üè∑Ô∏è –ü–æ—Ö–æ–∂–∏–µ —Ç–µ–≥–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π:</div>
        <div class="d-flex flex-wrap gap-2">
          {% for tag in similar_tags %}
            <a class="badge text-bg-light border text-decoration-none" href="{{ url_for('main.index', tag=tag.slug) }}">#{{ tag.name }}</a>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <article class="portal-article mt-3">
      {{ post.body | replace("\n", "<br>") | safe }}
    </article>

    {% if post.tracks %}
      <div class="portal-panel p-3 p-lg-4 mt-4">
        <div class="h5 mb-3">üéµ –¢—Ä–µ–∫–∏ ({{ post.tracks|length }})</div>
        <div class="d-flex flex-column gap-2">
          {% for track in post.tracks %}
            <div class="track-display p-3" style="background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.1); border-radius: 12px;">
              <div class="d-flex align-items-start justify-content-between gap-2">
                <div class="flex-grow-1">
                  <div class="fw-semibold">{{ track.title }}</div>
                  <div class="text-secondary small mt-1">{{ track.artist }}</div>
                </div>
                {% if track.url %}
                  <a href="{{ track.url }}" target="_blank" rel="noopener noreferrer" class="btn btn-sm btn-outline-primary">
                    <span>–°–ª—É—à–∞—Ç—å</span>
                    <span class="ms-1">‚Üó</span>
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <hr class="my-4">

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="h5 mb-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments|length }})</div>
        {% if comments %}
          <div class="d-flex flex-column gap-2">
            {% for c in comments %}
              <div class="portal-comment p-3">
                <div class="d-flex justify-content-between small text-secondary">
                  <div>
                    <a href="{{ url_for('main.profile', username=c.author.username) }}">{{ c.author.username }}</a>
                  </div>
                  <div>{{ c.created_at.strftime("%d.%m.%Y %H:%M") }}</div>
                </div>
                <div class="mt-2">{{ c.body | replace("\n", "<br>") | safe }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-secondary">–ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º ‚Äî –æ—Å—Ç–∞–≤—å—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.</div>
        {% endif %}
      </div>

      <div class="col-lg-6">
        <div class="h5 mb-3">–ù–∞–ø–∏—Å–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</div>
        {% if current_user.is_authenticated %}
          <form method="post" action="{{ url_for('main.add_comment', post_id=post.id) }}" class="portal-panel p-3">
            {{ form.hidden_tag() }}
            <div class="mb-3">
              {{ form.body(class_="form-control", rows="5", placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶") }}
              {% if form.body.errors %}
                <div class="form-text text-danger">{{ form.body.errors[0] }}</div>
              {% endif %}
            </div>
            <button class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </form>
        {% else %}
          <div class="portal-panel p-3">
            <div class="text-secondary mb-2">–ß—Ç–æ–±—ã –∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.</div>
            <a class="btn btn-outline-primary" href="{{ url_for('main.login') }}">–í–æ–π—Ç–∏</a>
            <a class="btn btn-primary ms-2" href="{{ url_for('main.register') }}">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  {% if current_user.is_authenticated %}
  <script>
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ—Å—Ç–∞ —Å –≤—Ä–µ–º–µ–Ω–µ–º
    let viewTracked = false;
    let lastProgress = 0;
    let viewStartTime = Date.now();
    let lastTrackTime = Date.now();
    
    function trackView(progress, isComplete) {
      if (viewTracked && !isComplete) return;
      
      // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      const currentTime = Date.now();
      const timeDelta = (currentTime - lastTrackTime) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
      lastTrackTime = currentTime;
      
      // –û–±—â–µ–µ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
      const totalViewTime = (currentTime - viewStartTime) / 1000;
      
      fetch('{{ url_for("main.track_post_view", post_id=post.id) }}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          progress: progress,
          is_complete: isComplete,
          view_duration: totalViewTime
        })
      })
      .then(response => response.json())
      .then(data => {
        lastProgress = data.progress;
      })
      .catch(error => console.error('–û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', error));
    }

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∞
    let scrollTimeout;
    window.addEventListener('scroll', function() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const progress = Math.min(1.0, (scrollTop + windowHeight) / documentHeight);
        const isComplete = progress >= 0.9;
        
        if (progress > lastProgress) {
          trackView(progress, isComplete);
        }
      }, 1000);
    });

    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.addEventListener('load', function() {
      viewStartTime = Date.now();
      lastTrackTime = Date.now();
      setTimeout(function() {
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const progress = Math.min(1.0, windowHeight / documentHeight);
        trackView(progress, progress >= 0.9);
      }, 2000);
    });
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
      const totalViewTime = (Date.now() - viewStartTime) / 1000;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      const progress = Math.min(1.0, (scrollTop + windowHeight) / documentHeight);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ sendBeacon
      const data = JSON.stringify({
        progress: progress,
        is_complete: progress >= 0.9,
        view_duration: totalViewTime
      });
      const blob = new Blob([data], { type: 'application/json' });
      navigator.sendBeacon('{{ url_for("main.track_post_view", post_id=post.id) }}', blob);
    });
  </script>
  {% endif %}
{% endblock %}


